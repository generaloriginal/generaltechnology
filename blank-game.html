<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blank Game</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#aab2d5; --text:#eef1ff;
      --good:#2dd4bf; --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1100px 600px at 30% 10%, #182252, var(--bg));color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:14px}
    .grid-full{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:20px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:999px}
    .pill b{font-variant-numeric:tabular-nums}
    .sentence{
      font-size:clamp(22px, 3.2vw, 38px);
      line-height:1.2;
      padding:14px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px dashed rgba(255,255,255,.16);
      margin:12px 0 14px;
      word-break:break-word;
    }
    .sentence.highlight-good{
      animation:sentencePulseGood 0.6s ease-out;
    }
    .sentence.highlight-bad{
      animation:sentencePulseBad 0.6s ease-out;
    }
    @keyframes sentencePulseGood{
      0%{background:rgba(45,212,191,.25);border-color:rgba(45,212,191,.45);transform:scale(1.02)}
      100%{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.16);transform:scale(1)}
    }
    @keyframes sentencePulseBad{
      0%{background:rgba(251,113,133,.25);border-color:rgba(251,113,133,.45);transform:scale(1.02)}
      100%{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.16);transform:scale(1)}
    }
    .answers{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .answers.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    .answers.five{grid-template-columns:repeat(5,minmax(0,1fr))}
    @media (max-width:560px){.answers.three{grid-template-columns:repeat(2,minmax(0,1fr))}.answers.five{grid-template-columns:repeat(3,minmax(0,1fr))}}
    button{
      cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);color:var(--text);
      border-radius:14px;padding:10px 12px;font-weight:700
    }
    button.primary{background:linear-gradient(135deg, rgba(96,165,250,.35), rgba(45,212,191,.25));border-color:rgba(96,165,250,.45)}
    button.danger{background:rgba(251,113,133,.14);border-color:rgba(251,113,133,.35)}
    button:disabled{opacity:.55;cursor:not-allowed}
    button.packBtn.active,button.durationBtn.active{background:linear-gradient(135deg, rgba(96,165,250,.35), rgba(45,212,191,.25));border-color:rgba(96,165,250,.45)}
    .ansBtn{
      font-size:clamp(16px, 2.3vw, 28px);
      padding:14px 12px;border-radius:16px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);
      text-transform:uppercase;letter-spacing:.9px;
    }
    .ansBtn.good{outline:3px solid rgba(45,212,191,.45);background:rgba(45,212,191,.15)}
    .ansBtn.bad{outline:3px solid rgba(251,113,133,.45);background:rgba(251,113,133,.12)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    select,input[type="text"],input[type="email"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);color:var(--text);outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}
    .toast{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05);font-size:13px}
    .toast.good{border-color:rgba(45,212,191,.35);background:rgba(45,212,191,.10)}
    .toast.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}
    .tiny{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{font-size:13px;padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{color:var(--muted);text-align:left;font-weight:700}
    #version{
      text-align:right;
      color:rgba(170,178,213,.6);
      font-size:12px;
      padding:10px;
      margin-top:10px;
    }
    .pill.highlight-good{
      animation:highlightPulseGood 0.6s ease-out;
    }
    .pill.highlight-bad{
      animation:highlightPulseBad 0.6s ease-out;
    }
    .pill.highlight-neutral{
      animation:highlightPulseNeutral 0.6s ease-out;
    }
    @keyframes highlightPulseGood{
      0%{background:rgba(45,212,191,.25);border-color:rgba(45,212,191,.45);transform:scale(1.05)}
      100%{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08);transform:scale(1)}
    }
    @keyframes highlightPulseBad{
      0%{background:rgba(251,113,133,.25);border-color:rgba(251,113,133,.45);transform:scale(1.05)}
      100%{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08);transform:scale(1)}
    }
    @keyframes highlightPulseNeutral{
      0%{background:rgba(96,165,250,.25);border-color:rgba(96,165,250,.45);transform:scale(1.05)}
      100%{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08);transform:scale(1)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1 style="margin:0 0 12px;font-size:20px">Fill in the Blank</h1>

        <div class="pillrow">
          <div class="pill" id="timePill">Time: <b id="timeLeft">30</b>s</div>
          <div class="pill" id="scorePill">Score: <b id="score">0</b></div>
          <div class="pill" id="accPill">Accuracy: <b id="acc">100</b>%</div>
        </div>

        <div id="sentence" class="sentence"></div>
        <div id="answers" class="answers"></div>

        <div class="row">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="primary" id="startBtn">Start</button>
            <button id="pauseBtn">Pause</button>
            <button class="danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div id="toast" class="toast"></div>
      </div>

      <div class="card">
        <h1 style="margin:0 0 12px;font-size:20px">Options</h1>
        <label>Pack</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
          <button class="packBtn" id="packBtnHomophone2" data-category="homophone" data-words="2">Homophone (2)</button>
          <button class="packBtn" id="packBtnHomophone3" data-category="homophone" data-words="3">Homophones (3)</button>
          <button class="packBtn" id="packBtnTenses" data-category="tenses">Tenses</button>
          <button class="packBtn" id="packBtnPrepositions" data-category="prepositions">Prepositions</button>
        </div>

        <label style="margin-top:14px;">Round length</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
          <button class="durationBtn" id="durationBtn15" data-duration="15">15 seconds</button>
          <button class="durationBtn" id="durationBtn30" data-duration="30">30 seconds</button>
          <button class="durationBtn" id="durationBtn60" data-duration="60">60 seconds</button>
          <button class="durationBtn" id="durationBtn90" data-duration="90">90 seconds</button>
        </div>
      </div>
    </div>

    <div class="grid-full">
      <div class="card">
        <h1 style="margin:0 0 12px;font-size:20px">Save Your Score</h1>
        <div class="row" style="align-items:flex-end;">
          <div style="flex:1;display:flex;gap:10px;flex-wrap:wrap;">
            <div style="flex:1;min-width:150px">
              <label>Name</label>
              <input id="nameInput" type="text" placeholder="John Smith" maxlength="24">
            </div>
            <div style="flex:1;min-width:150px">
              <label>Email</label>
              <input id="emailInput" type="email" placeholder="your@email.com" maxlength="100">
            </div>
          </div>
          <button class="primary" id="saveBtn" disabled>Save</button>
        </div>
      </div>
    </div>

    <div class="grid-full">
      <div class="card">
        <h1 style="margin:0 0 12px;font-size:20px">Leaderboard</h1>
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Score</th><th>Accuracy</th><th>Pack</th><th>When</th></tr></thead>
          <tbody id="lbBody"><tr><td colspan="6" class="tiny">No scores yet.</td></tr></tbody>
        </table>
      </div>
    </div>
    <div id="version">v1.0.9</div>
  </div>

<script>
const PACKS = [
  {
    id: "bad_bed",
    title: "BAD vs BED (2 words)",
    category: "homophone",
    options: ["bad","bed"],
    hint: "",
    items: [
      { s: "I went to ____ early because I was tired.", a: "bed", e: "" },
      { s: "It was a ____ day, so I stayed inside.", a: "bad", e: "" },
      { s: "Please don't jump on the ____.", a: "bed", e: "" },
      { s: "I feel ____ about missing the class.", a: "bad", e: "" },
      { s: "The ____ was very comfortable.", a: "bed", e: "" },
      { s: "That movie was really ____.", a: "bad", e: "" },
      { s: "She made the ____ this morning.", a: "bed", e: "" },
      { s: "The weather turned ____ suddenly.", a: "bad", e: "" },
      { s: "He slept in a hospital ____.", a: "bed", e: "" },
      { s: "Don't be ____ to your friends.", a: "bad", e: "" }
    ]
  },
  {
    id: "right_write",
    title: "RIGHT vs WRITE (2 words)",
    category: "homophone",
    options: ["right","write"],
    hint: "",
    items: [
      { s: "Turn ____ at the corner.", a: "right", e: "" },
      { s: "Please ____ your name here.", a: "write", e: "" },
      { s: "You are ____ about that.", a: "right", e: "" },
      { s: "I need to ____ a letter.", a: "write", e: "" },
      { s: "The answer is on the ____ side.", a: "right", e: "" },
      { s: "Can you ____ me a story?", a: "write", e: "" },
      { s: "That's the ____ answer!", a: "right", e: "" },
      { s: "I like to ____ in my journal.", a: "write", e: "" },
      { s: "My ____ hand is stronger.", a: "right", e: "" },
      { s: "She wants to ____ a book.", a: "write", e: "" }
    ]
  },
  {
    id: "here_hear",
    title: "HERE vs HEAR (2 words)",
    category: "homophone",
    options: ["here","hear"],
    hint: "",
    items: [
      { s: "Come ____ and sit down.", a: "here", e: "" },
      { s: "Can you ____ that sound?", a: "hear", e: "" },
      { s: "I'm standing right ____.", a: "here", e: "" },
      { s: "I can't ____ you very well.", a: "hear", e: "" },
      { s: "The book is ____ on the table.", a: "here", e: "" },
      { s: "Did you ____ what I said?", a: "hear", e: "" },
      { s: "Welcome ____ to our school.", a: "here", e: "" },
      { s: "I ____ music playing outside.", a: "hear", e: "" },
      { s: "Put it ____ next to me.", a: "here", e: "" },
      { s: "Can you ____ the birds singing?", a: "hear", e: "" }
    ]
  },
  {
    id: "see_sea",
    title: "SEE vs SEA (2 words)",
    category: "homophone",
    options: ["see","sea"],
    hint: "",
    items: [
      { s: "I can ____ the mountains.", a: "see", e: "" },
      { s: "The ____ is very blue today.", a: "sea", e: "" },
      { s: "Can you ____ that bird?", a: "see", e: "" },
      { s: "We swam in the ____.", a: "sea", e: "" },
      { s: "I want to ____ my friends.", a: "see", e: "" },
      { s: "The ____ was calm and peaceful.", a: "sea", e: "" },
      { s: "Do you ____ what I mean?", a: "see", e: "" },
      { s: "Fish live in the ____.", a: "sea", e: "" },
      { s: "Let me ____ if it works.", a: "see", e: "" },
      { s: "The ____ stretched to the horizon.", a: "sea", e: "" }
    ]
  },
  {
    id: "meat_meet",
    title: "MEAT vs MEET (2 words)",
    category: "homophone",
    options: ["meat","meet"],
    hint: "",
    items: [
      { s: "I don't eat ____ anymore.", a: "meat", e: "" },
      { s: "Let's ____ at the park.", a: "meet", e: "" },
      { s: "The ____ was cooked perfectly.", a: "meat", e: "" },
      { s: "I'll ____ you tomorrow.", a: "meet", e: "" },
      { s: "She bought fresh ____ at the store.", a: "meat", e: "" },
      { s: "We should ____ for coffee.", a: "meet", e: "" },
      { s: "The ____ is too expensive.", a: "meat", e: "" },
      { s: "Nice to ____ you!", a: "meet", e: "" },
      { s: "This ____ tastes delicious.", a: "meat", e: "" },
      { s: "Where should we ____?", a: "meet", e: "" }
    ]
  },
  {
    id: "peace_piece",
    title: "PEACE vs PIECE (2 words)",
    category: "homophone",
    options: ["peace","piece"],
    hint: "",
    items: [
      { s: "We need world ____.", a: "peace", e: "" },
      { s: "Can I have a ____ of cake?", a: "piece", e: "" },
      { s: "I just want some ____ and quiet.", a: "peace", e: "" },
      { s: "This ____ is missing from the puzzle.", a: "piece", e: "" },
      { s: "The treaty brought ____ to the region.", a: "peace", e: "" },
      { s: "She gave me a ____ of advice.", a: "piece", e: "" },
      { s: "Let me live in ____.", a: "peace", e: "" },
      { s: "Each ____ fits together perfectly.", a: "piece", e: "" },
      { s: "The garden is a place of ____.", a: "peace", e: "" },
      { s: "I need one more ____ to finish.", a: "piece", e: "" }
    ]
  },
  {
    id: "break_brake",
    title: "BREAK vs BRAKE (2 words)",
    category: "homophone",
    options: ["break","brake"],
    hint: "",
    items: [
      { s: "Don't ____ the window!", a: "break", e: "" },
      { s: "Press the ____ to stop the car.", a: "brake", e: "" },
      { s: "I need a ____ from work.", a: "break", e: "" },
      { s: "The car's ____ failed.", a: "brake", e: "" },
      { s: "Be careful not to ____ it.", a: "break", e: "" },
      { s: "The ____ pedal is on the left.", a: "brake", e: "" },
      { s: "Let's take a coffee ____.", a: "break", e: "" },
      { s: "The emergency ____ stopped the train.", a: "brake", e: "" },
      { s: "I hope I don't ____ my phone.", a: "break", e: "" },
      { s: "Check the ____ fluid regularly.", a: "brake", e: "" }
    ]
  },
  {
    id: "buy_by",
    title: "BUY vs BY (2 words)",
    category: "homophone",
    options: ["buy","by"],
    hint: "",
    items: [
      { s: "I want to ____ a new bike.", a: "buy", e: "" },
      { s: "The book was written ____ my friend.", a: "by", e: "" },
      { s: "Can you ____ me some milk?", a: "buy", e: "" },
      { s: "I'll be there ____ 3 o'clock.", a: "by", e: "" },
      { s: "Let's ____ tickets for the show.", a: "buy", e: "" },
      { s: "The house ____ the lake is beautiful.", a: "by", e: "" },
      { s: "I need to ____ groceries today.", a: "buy", e: "" },
      { s: "She walked ____ the store.", a: "by", e: "" },
      { s: "We should ____ a gift for her.", a: "buy", e: "" },
      { s: "Stand ____ me, please.", a: "by", e: "" }
    ]
  },
  {
    id: "to_too_two",
    title: "TO / TOO / TWO (3 words)",
    category: "homophone",
    options: ["to","too","two"],
    hint: "",
    items: [
      { s: "I want ____ go home.", a: "to", e: "" },
      { s: "I want ____ apples, please.", a: "two", e: "" },
      { s: "This is ____ expensive!", a: "too", e: "" },
      { s: "Let's go ____ the park.", a: "to", e: "" },
      { s: "I have ____ cats at home.", a: "two", e: "" },
      { s: "It's ____ hot outside today.", a: "too", e: "" },
      { s: "I need ____ finish my homework.", a: "to", e: "" },
      { s: "There are ____ many people here.", a: "too", e: "" },
      { s: "I'll be there in ____ hours.", a: "two", e: "" },
      { s: "She wants ____ learn Spanish.", a: "to", e: "" },
      { s: "This bag is ____ heavy for me.", a: "too", e: "" },
      { s: "We need ____ more chairs.", a: "two", e: "" }
    ]
  },
  {
    id: "their_there_theyre",
    title: "THEIR / THERE / THEY'RE (3 words)",
    category: "homophone",
    options: ["their","there","they're"],
    hint: "",
    items: [
      { s: "____ going to be late.", a: "they're", e: "" },
      { s: "Put the bag over ____.", a: "there", e: "" },
      { s: "That is ____ teacher.", a: "their", e: "" },
      { s: "____ house is very large.", a: "their", e: "" },
      { s: "I'll meet you ____ at noon.", a: "there", e: "" },
      { s: "____ the best students in class.", a: "they're", e: "" },
      { s: "____ car broke down yesterday.", a: "their", e: "" },
      { s: "Look ____ at that beautiful sunset!", a: "there", e: "" },
      { s: "____ planning a surprise party.", a: "they're", e: "" },
      { s: "____ dog is very friendly.", a: "their", e: "" },
      { s: "Don't go ____ alone.", a: "there", e: "" },
      { s: "____ coming to visit us.", a: "they're", e: "" }
    ]
  },
  {
    id: "your_youre_yore",
    title: "YOUR / YOU'RE / YORE (3 words)",
    category: "homophone",
    options: ["your","you're","yore"],
    hint: "",
    items: [
      { s: "Is this ____ book?", a: "your", e: "" },
      { s: "____ going to love this!", a: "you're", e: "" },
      { s: "In days of ____, life was different.", a: "yore", e: "" },
      { s: "____ phone is ringing.", a: "your", e: "" },
      { s: "____ the best friend I have.", a: "you're", e: "" },
      { s: "Stories from ____ are fascinating.", a: "yore", e: "" },
      { s: "What's ____ favorite color?", a: "your", e: "" },
      { s: "____ doing great work!", a: "you're", e: "" },
      { s: "Legends of ____ tell of heroes.", a: "yore", e: "" },
      { s: "____ idea sounds perfect.", a: "your", e: "" },
      { s: "____ welcome to join us.", a: "you're", e: "" },
      { s: "Tales from ____ are ancient.", a: "yore", e: "" }
    ]
  },
  {
    id: "where_wear_ware",
    title: "WHERE / WEAR / WARE (3 words)",
    category: "homophone",
    options: ["where","wear","ware"],
    hint: "",
    items: [
      { s: "____ are you going?", a: "where", e: "" },
      { s: "What should I ____ to the party?", a: "wear", e: "" },
      { s: "The kitchen ____ is on sale.", a: "ware", e: "" },
      { s: "Do you know ____ the store is?", a: "where", e: "" },
      { s: "I like to ____ comfortable shoes.", a: "wear", e: "" },
      { s: "The silver ____ is expensive.", a: "ware", e: "" },
      { s: "____ did you put my keys?", a: "where", e: "" },
      { s: "You should ____ a coat today.", a: "wear", e: "" },
      { s: "The pottery ____ is handmade.", a: "ware", e: "" },
      { s: "____ is the nearest bathroom?", a: "where", e: "" },
      { s: "I always ____ my seatbelt.", a: "wear", e: "" },
      { s: "The table ____ looks antique.", a: "ware", e: "" }
    ]
  },
  {
    id: "its_its",
    title: "ITS / IT'S (2 words)",
    category: "homophone",
    options: ["its","it's"],
    hint: "",
    items: [
      { s: "The cat licked ____ paw.", a: "its", e: "" },
      { s: "____ going to rain today.", a: "it's", e: "" },
      { s: "The tree lost ____ leaves.", a: "its", e: "" },
      { s: "____ time to go home.", a: "it's", e: "" },
      { s: "The dog wagged ____ tail.", a: "its", e: "" },
      { s: "____ a beautiful day outside.", a: "it's", e: "" },
      { s: "The bird built ____ nest.", a: "its", e: "" },
      { s: "____ important to study hard.", a: "it's", e: "" },
      { s: "The car lost ____ mirror.", a: "its", e: "" },
      { s: "____ been a long week.", a: "it's", e: "" }
    ]
  },
  {
    id: "tenses_past_present_future",
    title: "TENSES: Past / Present / Future",
    category: "tenses",
    options: ["went","go","will"],
    hint: "",
    items: [
      { s: "I ____ to the store yesterday.", a: "went", e: "" },
      { s: "I ____ to school every day.", a: "go", e: "" },
      { s: "I ____ visit my family next week.", a: "will", e: "" },
      { s: "She ____ to the library last week.", a: "went", e: "" },
      { s: "She ____ to work every morning.", a: "go", e: "" },
      { s: "She ____ start a new job tomorrow.", a: "will", e: "" },
      { s: "We ____ to the park yesterday.", a: "went", e: "" },
      { s: "We ____ to the gym every week.", a: "go", e: "" },
      { s: "We ____ have a party next Saturday.", a: "will", e: "" },
      { s: "They ____ to the beach last weekend.", a: "went", e: "" },
      { s: "They ____ to church every Sunday.", a: "go", e: "" },
      { s: "They ____ travel to Europe next year.", a: "will", e: "" },
      { s: "He ____ to the doctor last month.", a: "went", e: "" },
      { s: "He ____ to class every day.", a: "go", e: "" },
      { s: "He ____ graduate in June.", a: "will", e: "" },
      { s: "I ____ to the movies last Friday.", a: "went", e: "" },
      { s: "I ____ to the store on weekends.", a: "go", e: "" },
      { s: "I ____ see a new movie this weekend.", a: "will", e: "" }
    ]
  },
  {
    id: "prepositions_in_on_at_about_with",
    title: "PREPOSITIONS: In / On / At / About / With",
    category: "prepositions",
    options: ["in","on","at","about","with"],
    hint: "",
    items: [
      { s: "I live ____ New York.", a: "in", e: "" },
      { s: "The book is ____ the table.", a: "on", e: "" },
      { s: "I'll meet you ____ 3 o'clock.", a: "at", e: "" },
      { s: "What are you talking ____?", a: "about", e: "" },
      { s: "I went ____ my friend.", a: "with", e: "" },
      { s: "She works ____ a hospital.", a: "in", e: "" },
      { s: "The picture is hanging ____ the wall.", a: "on", e: "" },
      { s: "We'll arrive ____ the airport.", a: "at", e: "" },
      { s: "Tell me ____ your day.", a: "about", e: "" },
      { s: "I agree ____ you.", a: "with", e: "" },
      { s: "The cat is ____ the box.", a: "in", e: "" },
      { s: "Put your shoes ____ the floor.", a: "on", e: "" },
      { s: "I'll see you ____ school.", a: "at", e: "" },
      { s: "I'm thinking ____ you.", a: "about", e: "" },
      { s: "She lives ____ her parents.", a: "with", e: "" },
      { s: "I'm ____ the kitchen.", a: "in", e: "" },
      { s: "The keys are ____ the door.", a: "on", e: "" },
      { s: "Let's meet ____ the park.", a: "at", e: "" },
      { s: "What is this book ____?", a: "about", e: "" },
      { s: "I'll come ____ you.", a: "with", e: "" },
      { s: "She's ____ trouble.", a: "in", e: "" },
      { s: "The pen is ____ my desk.", a: "on", e: "" },
      { s: "I'll be there ____ noon.", a: "at", e: "" },
      { s: "I'm worried ____ you.", a: "about", e: "" },
      { s: "Can I help ____ that?", a: "with", e: "" }
    ]
  }
];

// Supabase configuration (same as snake game)
const SUPABASE_URL = 'https://bmnixnmqferqlcxublii.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_IidrOPKjc9tkqOwjJMhrrQ_z35awXmc'; // Public anon key (safe to expose in client code)
const LEADERBOARD_TABLE = 'homophone_leaderboard'; // Different table for homophone game

let useSupabase = false;

// Check if Supabase is configured
if (SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && 
    SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
  useSupabase = true;
  console.log("Using Supabase for server-side leaderboard");
} else {
  console.log("Supabase not configured - using localStorage (fallback)");
}

// DOM + game logic
const elSentence=document.getElementById("sentence");
const elAnswers=document.getElementById("answers");
const elTime=document.getElementById("timeLeft");
const elScore=document.getElementById("score");
const elAcc=document.getElementById("acc");
const timePill=document.getElementById("timePill");
const scorePill=document.getElementById("scorePill");
const accPill=document.getElementById("accPill");
const startBtn=document.getElementById("startBtn");
const pauseBtn=document.getElementById("pauseBtn");
const resetBtn=document.getElementById("resetBtn");
const elToast=document.getElementById("toast");
const nameInput=document.getElementById("nameInput");
const emailInput=document.getElementById("emailInput");
const saveBtn=document.getElementById("saveBtn");
const lbBody=document.getElementById("lbBody");

let currentPack=null,currentItem=null;
let timer=null,running=false,timeLeft=30;
let score=0,streak=0,correct=0,total=0;
let selectedCategory="homophone"; // Default category
let selectedWordCount=2; // For homophone packs
let selectedDuration=30; // Default to 30 seconds
let nameSubmitted=false;
let prevScore=0,prevAcc=100,prevTime=30;

function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function shuffle(a){a=a.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function highlightPill(pillEl,color="neutral"){
  pillEl.classList.remove("highlight-good","highlight-bad","highlight-neutral");
  void pillEl.offsetWidth; // Trigger reflow
  if(color==="good")pillEl.classList.add("highlight-good");
  else if(color==="bad")pillEl.classList.add("highlight-bad");
  else pillEl.classList.add("highlight-neutral");
  setTimeout(()=>pillEl.classList.remove("highlight-good","highlight-bad","highlight-neutral"),600);
}
function renderStats(highlightScore=false,highlightAcc=false,highlightTime=false,accIsGood=true){
  const newAcc=total?Math.round(correct/total*100):100;
  if(highlightTime&&timeLeft!==prevTime){
    elTime.textContent=timeLeft;
    highlightPill(timePill,"neutral");
    prevTime=timeLeft;
  }else if(!highlightTime){
    elTime.textContent=timeLeft;
    prevTime=timeLeft;
  }
  if(highlightScore&&score!==prevScore){
    elScore.textContent=score;
    highlightPill(scorePill,"good");
    prevScore=score;
  }else if(!highlightScore){
    elScore.textContent=score;
    prevScore=score;
  }
  if(highlightAcc){
    elAcc.textContent=newAcc;
    highlightPill(accPill,accIsGood?"good":"bad");
    prevAcc=newAcc;
  }else{
    elAcc.textContent=newAcc;
    prevAcc=newAcc;
  }
}
function nextQ(){
  currentItem=pick(currentPack.items);
  elSentence.textContent=currentItem.s;
  elAnswers.innerHTML="";
  let className="answers";
  if(currentPack.options.length===3)className+=" three";
  else if(currentPack.options.length===5)className+=" five";
  elAnswers.className=className;
  shuffle(currentPack.options).forEach(w=>{
    const b=document.createElement("button");
    b.className="ansBtn";
    b.textContent=w;
    b.onclick=()=>answer(w,b);
    elAnswers.appendChild(b);
  });
}
function highlightSentence(isGood){
  elSentence.classList.remove("highlight-good","highlight-bad");
  void elSentence.offsetWidth; // Trigger reflow
  elSentence.classList.add(isGood?"highlight-good":"highlight-bad");
  setTimeout(()=>elSentence.classList.remove("highlight-good","highlight-bad"),600);
}
function answer(w,b){
  if(!running)return;
  total++;
  const wasCorrect=w===currentItem.a;
  const timeChanged=!wasCorrect&&timeLeft>0;
  if(wasCorrect){correct++;streak++;score++;b.classList.add("good")}
  else{streak=0;timeLeft=Math.max(0,timeLeft-2);b.classList.add("bad")}
  highlightSentence(wasCorrect);
  renderStats(wasCorrect,true,timeChanged,wasCorrect);
  setTimeout(()=>{if(timeLeft<=0)end();else nextQ()},300);
}
function start(){
  if(running)return;
  running=true;
  if(!currentItem)nextQ();
  timer=setInterval(()=>{timeLeft--;renderStats(false,false,true);if(timeLeft<=0)end()},1000);
}
function end(){
  clearInterval(timer);
  timer=null;
  running=false;
  displayLeaderboard();
  nameSubmitted=false;
  saveBtn.disabled=!nameInput.value.trim();
}
function resetGame(){if(timer)clearInterval(timer);running=false;score=streak=correct=total=0;timeLeft=selectedDuration;prevScore=0;prevAcc=100;prevTime=selectedDuration;renderStats();if(currentPack)nextQ()}

function setPackByCategory(category,wordCount=null){
  selectedCategory=category;
  if(wordCount)selectedWordCount=wordCount;
  let availablePacks;
  if(category==="homophone"&&wordCount){
    availablePacks=PACKS.filter(p=>p.category==="homophone"&&p.options.length===wordCount);
  }else{
    availablePacks=PACKS.filter(p=>p.category===category);
  }
  if(availablePacks.length>0){
    currentPack=pick(availablePacks);
    resetGame();
  }
  // Update button states
  document.querySelectorAll('.packBtn').forEach(btn=>{
    const btnCategory=btn.dataset.category;
    const btnWords=btn.dataset.words;
    if(category==="homophone"&&wordCount){
      btn.classList.toggle('active',btnCategory===category&&btnWords==wordCount);
    }else{
      btn.classList.toggle('active',btnCategory===category);
    }
  });
}

function setDuration(duration){
  selectedDuration=duration;
  timeLeft=duration;
  renderStats();
  // Update button states
  document.querySelectorAll('.durationBtn').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.duration==duration);
  });
}

// Pack selection buttons
document.getElementById("packBtnHomophone2").onclick=()=>setPackByCategory("homophone",2);
document.getElementById("packBtnHomophone3").onclick=()=>setPackByCategory("homophone",3);
document.getElementById("packBtnTenses").onclick=()=>setPackByCategory("tenses");
document.getElementById("packBtnPrepositions").onclick=()=>setPackByCategory("prepositions");

// Duration selection buttons
document.getElementById("durationBtn15").onclick=()=>setDuration(15);
document.getElementById("durationBtn30").onclick=()=>setDuration(30);
document.getElementById("durationBtn60").onclick=()=>setDuration(60);
document.getElementById("durationBtn90").onclick=()=>setDuration(90);

startBtn.onclick=start;
resetBtn.onclick=resetGame;

// Initialize with default pack
setPackByCategory("homophone",2);
setDuration(30); // Default to 30 seconds
renderStats();

// Supabase leaderboard functions
async function getHighScores() {
  if (useSupabase) {
    try {
      // Try to fetch with new columns first (email, pack)
      let response = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=name,score,date,duration,accuracy,email,pack&order=score.desc&limit=50`, {
        method: 'GET',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        }
      });
      
      // If that fails (columns don't exist), try without email and pack
      if (!response.ok && response.status !== 404) {
        console.log("âš ï¸ Trying fetch without email/pack columns...");
        response = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=name,score,date,duration,accuracy&order=score.desc&limit=50`, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          }
        });
      }
      
      if (response.ok) {
        const scores = await response.json();
        console.log("ðŸ“Š Fetched scores from Supabase:", scores.length, "entries");
        // Map and normalize scores (sort by score per second)
        const mapped = scores.map(s => ({
          name: s.name || "Anonymous",
          score: s.score || 0,
          date: s.date || (() => {
            const now = new Date();
            return now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          })(),
          duration: s.duration || 30, // Default to 30 if missing
          accuracy: s.accuracy || null,
          email: s.email || null,
          pack: s.pack || null
        }));
        // Sort by normalized score (score per second)
        mapped.sort((a, b) => {
          const aNorm = a.duration ? a.score / a.duration : 0;
          const bNorm = b.duration ? b.score / b.duration : 0;
          return bNorm - aNorm;
        });
        // Return top 10
        return mapped.slice(0, 10);
      } else {
        const errorText = await response.text();
        console.error("âŒ Error fetching from Supabase:", response.status, errorText);
        // If table doesn't exist, fall back to localStorage
        if (response.status === 404) {
          console.log("âš ï¸ Supabase table not found, using localStorage");
        }
      }
    } catch (error) {
      console.error("âŒ Error fetching scores from Supabase:", error);
    }
  }
  
  // Fallback to localStorage
  try {
    const stored = localStorage.getItem('homophone_leaderboard');
    const scores = stored ? JSON.parse(stored) : [];
    if (scores.length > 0) {
      console.log("ðŸ“Š Fetched scores from localStorage:", scores.length, "entries");
      // Ensure all scores have required fields (defaults if missing)
      scores.forEach(s => {
        if (!s.duration) s.duration = 30;
        if (!s.email) s.email = null;
        if (!s.pack) s.pack = null;
      });
      // Sort by normalized score (score per second)
      scores.sort((a, b) => {
        const aNorm = a.duration ? a.score / a.duration : 0;
        const bNorm = b.duration ? b.score / b.duration : 0;
        return bNorm - aNorm;
      });
      // Return top 10
      return scores.slice(0, 10);
    }
    return scores;
  } catch (e) {
    console.error("âŒ Error reading from localStorage:", e);
    return [];
  }
}

async function saveHighScores(scores) {
  let supabaseSuccess = false;
  
  if (useSupabase) {
    try {
      // Get ALL existing scores from database first
      // Try with all columns first, fall back to basic columns if email/pack don't exist
      let getAllResponse = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=id,name,score,date,duration,accuracy,email,pack&limit=1000`, {
        method: 'GET',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        }
      });
      
      // If that fails, try without email/pack
      if (!getAllResponse.ok && getAllResponse.status !== 404) {
        console.log("âš ï¸ Trying fetch without email/pack columns...");
        getAllResponse = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=id,name,score,date,duration,accuracy&limit=1000`, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          }
        });
      }
      
      let existingScores = [];
      let canFetchExisting = false;
      if (getAllResponse.ok) {
        existingScores = await getAllResponse.json();
        console.log("ðŸ“Š Found", existingScores.length, "existing scores in database");
        canFetchExisting = true;
      } else {
        console.error("âŒ Failed to fetch existing scores:", getAllResponse.status);
        console.log("âš ï¸ Will only insert new score without deleting existing ones");
      }
      
      let newScores = scores;
      
      if (canFetchExisting) {
        // Merge existing scores with new scores, avoiding duplicates
        const scoreMap = new Map();
        
        // Add existing scores to map
        existingScores.forEach(s => {
          const key = `${s.name}_${s.score}_${s.date}`;
          scoreMap.set(key, {
            name: s.name,
            score: s.score,
            date: s.date,
            duration: s.duration || 30,
            accuracy: s.accuracy || null,
            email: s.email || null,
            pack: s.pack || null
          });
        });
        
        // Add/update with new scores
        scores.forEach(s => {
          const key = `${s.name}_${s.score}_${s.date}`;
          scoreMap.set(key, s);
        });
        
        // Convert back to array, sort, and keep top 10
        const allScores = Array.from(scoreMap.values());
        allScores.sort((a, b) => {
          const aNorm = a.duration ? a.score / a.duration : 0;
          const bNorm = b.duration ? b.score / b.duration : 0;
          return bNorm - aNorm;
        });
        const topScores = allScores.slice(0, 10);
        
        // Get IDs of scores to delete (ones not in top 10)
        const topKeys = new Set(topScores.map(s => `${s.name}_${s.score}_${s.date}`));
        const idsToDelete = existingScores
          .filter(s => !topKeys.has(`${s.name}_${s.score}_${s.date}`))
          .map(s => s.id);
        
        // Delete scores that are no longer in top 10
        // Only delete if we successfully fetched existing scores and have IDs
        if (idsToDelete.length > 0 && existingScores.length > 0) {
          console.log("ðŸ—‘ï¸ Deleting", idsToDelete.length, "scores that fell out of top 10");
          const deleteResponse = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?id=in.(${idsToDelete.join(',')})`, {
            method: 'DELETE',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            }
          });
          if (!deleteResponse.ok) {
            console.error("âŒ Failed to delete scores:", deleteResponse.status);
            // Don't proceed with insert if delete failed - data might be inconsistent
            throw new Error("Failed to clean up old scores");
          }
        }
        
        // Insert/update scores that are new or changed
        const existingKeys = new Set(existingScores.map(s => `${s.name}_${s.score}_${s.date}`));
        newScores = topScores.filter(s => !existingKeys.has(`${s.name}_${s.score}_${s.date}`));
      } else {
        // If we can't fetch existing scores, just insert the new ones without deleting anything
        console.log("âš ï¸ Inserting new scores without managing existing ones (safety mode)");
        console.log("âš ï¸ This means existing scores will remain, but leaderboard might exceed 10 entries");
      }
      
      // Only proceed with save if we have scores to save
      if (newScores.length > 0) {
        console.log("ðŸ’¾ Preparing to save", newScores.length, "new/updated score(s)");
        const scoresToSave = newScores.map(s => {
          const scoreData = {
            name: s.name,
            score: s.score,
            date: s.date,
            duration: s.duration
          };
          if (s.accuracy != null) {
            scoreData.accuracy = s.accuracy;
          }
          if (s.email != null) {
            scoreData.email = s.email;
          }
          if (s.pack != null) {
            scoreData.pack = s.pack;
          }
          return scoreData;
        });
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(scoresToSave)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log("âœ… Leaderboard updated! Saved", result.length, "new entries to Supabase");
          console.log("âœ… All existing scores preserved");
          supabaseSuccess = true;
        } else {
          const errorText = await response.text();
          console.error("âŒ Error saving to Supabase:", response.status, errorText);
          // If save fails, existing scores should still be intact
          console.log("âš ï¸ Save failed, but existing scores should still be safe");
        }
      } else {
        if (canFetchExisting) {
          console.log("âœ… No new scores to add - all scores already in database");
        } else {
          console.log("âœ… Score already exists or no new scores to add");
        }
        supabaseSuccess = true;
      }
    } catch (error) {
      console.error("âŒ Error saving scores to Supabase:", error);
    }
  }
  
  // Always save to localStorage as backup (or primary if Supabase fails)
  try {
    localStorage.setItem('homophone_leaderboard', JSON.stringify(scores));
    if (supabaseSuccess) {
      console.log("ðŸ’¾ Scores also saved locally as backup");
    } else {
      console.log("ðŸ’¾ Scores saved locally (Supabase not configured or unavailable)");
    }
  } catch (e) {
    console.error("âŒ Error saving to localStorage:", e);
  }
}

async function addHighScore(name, email, score, accuracy, pack) {
  const scores = await getHighScores();
  const now = new Date();
  const date = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  const duration = selectedDuration; // Store the duration used for this game
  
  // Remove any existing entry with same name and score (avoid duplicates)
  const filtered = scores.filter(s => !(s.name === name && s.score === score));
  filtered.push({ name: name || "Anonymous", email: email || null, score: score, date: date, duration: duration, accuracy: accuracy, pack: pack || null });
  
  // Sort by normalized score (score per second) to account for different game lengths
  // Calculate normalized score: score / duration (higher is better)
  filtered.sort((a, b) => {
    const aNorm = a.duration ? a.score / a.duration : 0;
    const bNorm = b.duration ? b.score / b.duration : 0;
    return bNorm - aNorm; // Sort descending (highest normalized score first)
  });
  // Keep only top 10
  const topScores = filtered.slice(0, 10);
  
  await saveHighScores(topScores);
  return topScores;
}

async function displayLeaderboard() {
  const scores = await getHighScores();
  if (scores.length === 0) {
    lbBody.innerHTML = '<tr><td colspan="6" class="tiny">No scores yet.</td></tr>';
    return;
  }
  
  lbBody.innerHTML = scores.map((s, i) => {
    const duration = s.duration ? ` (${s.duration}s)` : '';
    const accuracy = s.accuracy !== undefined ? `${s.accuracy}%` : 'N/A';
    const pack = s.pack || 'N/A';
    return `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.score}</td><td>${accuracy}</td><td>${pack}</td><td>${s.date}${duration}</td></tr>`;
  }).join('');
}

// Save button handler
saveBtn.onclick=async function(e){
  e.preventDefault();
  e.stopPropagation();
  if(nameSubmitted)return;
  const name=nameInput.value.trim()||"Anonymous";
  if(!name)return;
  const email=emailInput.value.trim()||null;
  const currentScore=score; // Capture current score
  const currentAccuracy=total?Math.round(correct/total*100):100; // Capture current accuracy
  const packName=currentPack?currentPack.title:null; // Get the pack title
  nameSubmitted=true;
  saveBtn.disabled=true;
  try {
    await addHighScore(name,email,currentScore,currentAccuracy,packName);
    await displayLeaderboard();
    elToast.textContent=`Score saved!`;
    elToast.className="toast good";
    elToast.style.display="block";
    setTimeout(()=>{elToast.style.display="none"},3000);
  } catch(error) {
    console.error("Error saving score:", error);
    elToast.textContent=`Error saving score. Please try again.`;
    elToast.className="toast bad";
    elToast.style.display="block";
    nameSubmitted=false;
    saveBtn.disabled=false;
  }
};

// Update save button state
nameInput.addEventListener("input",()=>{
  saveBtn.disabled=!nameInput.value.trim()||nameSubmitted;
});

// Load leaderboard on page load
displayLeaderboard();
</script>
</body>
</html>