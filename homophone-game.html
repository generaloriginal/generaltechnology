<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confusable Words â€“ Rapid Tap (v2)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#aab2d5; --text:#eef1ff;
      --good:#2dd4bf; --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1100px 600px at 30% 10%, #182252, var(--bg));color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:14px}
    .grid-full{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:20px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:999px}
    .pill b{font-variant-numeric:tabular-nums}
    .sentence{
      font-size:clamp(22px, 3.2vw, 38px);
      line-height:1.2;
      padding:14px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px dashed rgba(255,255,255,.16);
      margin:12px 0 14px;
      word-break:break-word;
    }
    .answers{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .answers.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:560px){.answers.three{grid-template-columns:repeat(2,minmax(0,1fr))}}
    button{
      cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);color:var(--text);
      border-radius:14px;padding:10px 12px;font-weight:700
    }
    button.primary{background:linear-gradient(135deg, rgba(96,165,250,.35), rgba(45,212,191,.25));border-color:rgba(96,165,250,.45)}
    button.danger{background:rgba(251,113,133,.14);border-color:rgba(251,113,133,.35)}
    button:disabled{opacity:.55;cursor:not-allowed}
    button.packBtn.active,button.durationBtn.active{background:linear-gradient(135deg, rgba(96,165,250,.35), rgba(45,212,191,.25));border-color:rgba(96,165,250,.45)}
    .ansBtn{
      font-size:clamp(16px, 2.3vw, 28px);
      padding:14px 12px;border-radius:16px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);
      text-transform:uppercase;letter-spacing:.9px;
    }
    .ansBtn.good{outline:3px solid rgba(45,212,191,.45);background:rgba(45,212,191,.15)}
    .ansBtn.bad{outline:3px solid rgba(251,113,133,.45);background:rgba(251,113,133,.12)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    select,input[type="text"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);color:var(--text);outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}
    .toast{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05);font-size:13px}
    .toast.good{border-color:rgba(45,212,191,.35);background:rgba(45,212,191,.10)}
    .toast.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}
    .tiny{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{font-size:13px;padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{color:var(--muted);text-align:left;font-weight:700}
    #version{
      text-align:right;
      color:rgba(170,178,213,.6);
      font-size:12px;
      padding:10px;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">

        <div class="pillrow">
          <div class="pill">Time: <b id="timeLeft">30</b>s</div>
          <div class="pill">Score: <b id="score">0</b></div>
          <div class="pill">Accuracy: <b id="acc">100</b>%</div>
        </div>

        <div id="sentence" class="sentence"></div>
        <div id="answers" class="answers"></div>

        <div class="row">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="primary" id="startBtn">Start</button>
            <button id="pauseBtn">Pause</button>
            <button class="danger" id="resetBtn">Reset</button>
          </div>
        </div>

        <div id="toast" class="toast"></div>
      </div>

      <div class="card">
        <label>Pack</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
          <button class="packBtn" id="packBtn2" data-words="2">2 words</button>
          <button class="packBtn" id="packBtn3" data-words="3">3 words</button>
        </div>

        <label style="margin-top:14px;">Round length</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
          <button class="durationBtn" id="durationBtn30" data-duration="30">30 seconds</button>
          <button class="durationBtn" id="durationBtn60" data-duration="60">60 seconds</button>
          <button class="durationBtn" id="durationBtn90" data-duration="90">90 seconds</button>
        </div>

        <div style="height:1px;background:rgba(255,255,255,.10);margin:14px 0"></div>

        <div class="row" style="align-items:flex-end;">
          <div style="flex:1">
            <label>Name</label>
            <input id="nameInput" type="text" placeholder="Team Blue" maxlength="24">
          </div>
          <button class="primary" id="saveBtn" disabled>Save</button>
        </div>
      </div>
    </div>

    <div class="grid-full">
      <div class="card">
        <h1 style="margin:0 0 12px;font-size:20px">Leaderboard</h1>
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Score</th><th>When</th></tr></thead>
          <tbody id="lbBody"><tr><td colspan="4" class="tiny">No scores yet.</td></tr></tbody>
        </table>
      </div>
    </div>
    <div id="version">v1.0.1</div>
  </div>

<script>
const PACKS = [
  {
    id: "bad_bed",
    title: "BAD vs BED (2 words)",
    options: ["bad","bed"],
    hint: "",
    items: [
      { s: "I went to ____ early because I was tired.", a: "bed", e: "" },
      { s: "It was a ____ day, so I stayed inside.", a: "bad", e: "" },
      { s: "Please don't jump on the ____.", a: "bed", e: "" },
      { s: "I feel ____ about missing the class.", a: "bad", e: "" },
      { s: "The ____ was very comfortable.", a: "bed", e: "" },
      { s: "That movie was really ____.", a: "bad", e: "" },
      { s: "She made the ____ this morning.", a: "bed", e: "" },
      { s: "The weather turned ____ suddenly.", a: "bad", e: "" },
      { s: "He slept in a hospital ____.", a: "bed", e: "" },
      { s: "Don't be ____ to your friends.", a: "bad", e: "" }
    ]
  },
  {
    id: "right_write",
    title: "RIGHT vs WRITE (2 words)",
    options: ["right","write"],
    hint: "",
    items: [
      { s: "Turn ____ at the corner.", a: "right", e: "" },
      { s: "Please ____ your name here.", a: "write", e: "" },
      { s: "You are ____ about that.", a: "right", e: "" },
      { s: "I need to ____ a letter.", a: "write", e: "" },
      { s: "The answer is on the ____ side.", a: "right", e: "" },
      { s: "Can you ____ me a story?", a: "write", e: "" },
      { s: "That's the ____ answer!", a: "right", e: "" },
      { s: "I like to ____ in my journal.", a: "write", e: "" },
      { s: "My ____ hand is stronger.", a: "right", e: "" },
      { s: "She wants to ____ a book.", a: "write", e: "" }
    ]
  },
  {
    id: "here_hear",
    title: "HERE vs HEAR (2 words)",
    options: ["here","hear"],
    hint: "",
    items: [
      { s: "Come ____ and sit down.", a: "here", e: "" },
      { s: "Can you ____ that sound?", a: "hear", e: "" },
      { s: "I'm standing right ____.", a: "here", e: "" },
      { s: "I can't ____ you very well.", a: "hear", e: "" },
      { s: "The book is ____ on the table.", a: "here", e: "" },
      { s: "Did you ____ what I said?", a: "hear", e: "" },
      { s: "Welcome ____ to our school.", a: "here", e: "" },
      { s: "I ____ music playing outside.", a: "hear", e: "" },
      { s: "Put it ____ next to me.", a: "here", e: "" },
      { s: "Can you ____ the birds singing?", a: "hear", e: "" }
    ]
  },
  {
    id: "see_sea",
    title: "SEE vs SEA (2 words)",
    options: ["see","sea"],
    hint: "",
    items: [
      { s: "I can ____ the mountains.", a: "see", e: "" },
      { s: "The ____ is very blue today.", a: "sea", e: "" },
      { s: "Can you ____ that bird?", a: "see", e: "" },
      { s: "We swam in the ____.", a: "sea", e: "" },
      { s: "I want to ____ my friends.", a: "see", e: "" },
      { s: "The ____ was calm and peaceful.", a: "sea", e: "" },
      { s: "Do you ____ what I mean?", a: "see", e: "" },
      { s: "Fish live in the ____.", a: "sea", e: "" },
      { s: "Let me ____ if it works.", a: "see", e: "" },
      { s: "The ____ stretched to the horizon.", a: "sea", e: "" }
    ]
  },
  {
    id: "meat_meet",
    title: "MEAT vs MEET (2 words)",
    options: ["meat","meet"],
    hint: "",
    items: [
      { s: "I don't eat ____ anymore.", a: "meat", e: "" },
      { s: "Let's ____ at the park.", a: "meet", e: "" },
      { s: "The ____ was cooked perfectly.", a: "meat", e: "" },
      { s: "I'll ____ you tomorrow.", a: "meet", e: "" },
      { s: "She bought fresh ____ at the store.", a: "meat", e: "" },
      { s: "We should ____ for coffee.", a: "meet", e: "" },
      { s: "The ____ is too expensive.", a: "meat", e: "" },
      { s: "Nice to ____ you!", a: "meet", e: "" },
      { s: "This ____ tastes delicious.", a: "meat", e: "" },
      { s: "Where should we ____?", a: "meet", e: "" }
    ]
  },
  {
    id: "peace_piece",
    title: "PEACE vs PIECE (2 words)",
    options: ["peace","piece"],
    hint: "",
    items: [
      { s: "We need world ____.", a: "peace", e: "" },
      { s: "Can I have a ____ of cake?", a: "piece", e: "" },
      { s: "I just want some ____ and quiet.", a: "peace", e: "" },
      { s: "This ____ is missing from the puzzle.", a: "piece", e: "" },
      { s: "The treaty brought ____ to the region.", a: "peace", e: "" },
      { s: "She gave me a ____ of advice.", a: "piece", e: "" },
      { s: "Let me live in ____.", a: "peace", e: "" },
      { s: "Each ____ fits together perfectly.", a: "piece", e: "" },
      { s: "The garden is a place of ____.", a: "peace", e: "" },
      { s: "I need one more ____ to finish.", a: "piece", e: "" }
    ]
  },
  {
    id: "break_brake",
    title: "BREAK vs BRAKE (2 words)",
    options: ["break","brake"],
    hint: "",
    items: [
      { s: "Don't ____ the window!", a: "break", e: "" },
      { s: "Press the ____ to stop the car.", a: "brake", e: "" },
      { s: "I need a ____ from work.", a: "break", e: "" },
      { s: "The car's ____ failed.", a: "brake", e: "" },
      { s: "Be careful not to ____ it.", a: "break", e: "" },
      { s: "The ____ pedal is on the left.", a: "brake", e: "" },
      { s: "Let's take a coffee ____.", a: "break", e: "" },
      { s: "The emergency ____ stopped the train.", a: "brake", e: "" },
      { s: "I hope I don't ____ my phone.", a: "break", e: "" },
      { s: "Check the ____ fluid regularly.", a: "brake", e: "" }
    ]
  },
  {
    id: "buy_by",
    title: "BUY vs BY (2 words)",
    options: ["buy","by"],
    hint: "",
    items: [
      { s: "I want to ____ a new bike.", a: "buy", e: "" },
      { s: "The book was written ____ my friend.", a: "by", e: "" },
      { s: "Can you ____ me some milk?", a: "buy", e: "" },
      { s: "I'll be there ____ 3 o'clock.", a: "by", e: "" },
      { s: "Let's ____ tickets for the show.", a: "buy", e: "" },
      { s: "The house ____ the lake is beautiful.", a: "by", e: "" },
      { s: "I need to ____ groceries today.", a: "buy", e: "" },
      { s: "She walked ____ the store.", a: "by", e: "" },
      { s: "We should ____ a gift for her.", a: "buy", e: "" },
      { s: "Stand ____ me, please.", a: "by", e: "" }
    ]
  },
  {
    id: "to_too_two",
    title: "TO / TOO / TWO (3 words)",
    options: ["to","too","two"],
    hint: "",
    items: [
      { s: "I want ____ go home.", a: "to", e: "" },
      { s: "I want ____ apples, please.", a: "two", e: "" },
      { s: "This is ____ expensive!", a: "too", e: "" },
      { s: "Let's go ____ the park.", a: "to", e: "" },
      { s: "I have ____ cats at home.", a: "two", e: "" },
      { s: "It's ____ hot outside today.", a: "too", e: "" },
      { s: "I need ____ finish my homework.", a: "to", e: "" },
      { s: "There are ____ many people here.", a: "too", e: "" },
      { s: "I'll be there in ____ hours.", a: "two", e: "" },
      { s: "She wants ____ learn Spanish.", a: "to", e: "" },
      { s: "This bag is ____ heavy for me.", a: "too", e: "" },
      { s: "We need ____ more chairs.", a: "two", e: "" }
    ]
  },
  {
    id: "their_there_theyre",
    title: "THEIR / THERE / THEY'RE (3 words)",
    options: ["their","there","they're"],
    hint: "",
    items: [
      { s: "____ going to be late.", a: "they're", e: "" },
      { s: "Put the bag over ____.", a: "there", e: "" },
      { s: "That is ____ teacher.", a: "their", e: "" },
      { s: "____ house is very large.", a: "their", e: "" },
      { s: "I'll meet you ____ at noon.", a: "there", e: "" },
      { s: "____ the best students in class.", a: "they're", e: "" },
      { s: "____ car broke down yesterday.", a: "their", e: "" },
      { s: "Look ____ at that beautiful sunset!", a: "there", e: "" },
      { s: "____ planning a surprise party.", a: "they're", e: "" },
      { s: "____ dog is very friendly.", a: "their", e: "" },
      { s: "Don't go ____ alone.", a: "there", e: "" },
      { s: "____ coming to visit us.", a: "they're", e: "" }
    ]
  },
  {
    id: "your_youre_yore",
    title: "YOUR / YOU'RE / YORE (3 words)",
    options: ["your","you're","yore"],
    hint: "",
    items: [
      { s: "Is this ____ book?", a: "your", e: "" },
      { s: "____ going to love this!", a: "you're", e: "" },
      { s: "In days of ____, life was different.", a: "yore", e: "" },
      { s: "____ phone is ringing.", a: "your", e: "" },
      { s: "____ the best friend I have.", a: "you're", e: "" },
      { s: "Stories from ____ are fascinating.", a: "yore", e: "" },
      { s: "What's ____ favorite color?", a: "your", e: "" },
      { s: "____ doing great work!", a: "you're", e: "" },
      { s: "Legends of ____ tell of heroes.", a: "yore", e: "" },
      { s: "____ idea sounds perfect.", a: "your", e: "" },
      { s: "____ welcome to join us.", a: "you're", e: "" },
      { s: "Tales from ____ are ancient.", a: "yore", e: "" }
    ]
  },
  {
    id: "where_wear_ware",
    title: "WHERE / WEAR / WARE (3 words)",
    options: ["where","wear","ware"],
    hint: "",
    items: [
      { s: "____ are you going?", a: "where", e: "" },
      { s: "What should I ____ to the party?", a: "wear", e: "" },
      { s: "The kitchen ____ is on sale.", a: "ware", e: "" },
      { s: "Do you know ____ the store is?", a: "where", e: "" },
      { s: "I like to ____ comfortable shoes.", a: "wear", e: "" },
      { s: "The silver ____ is expensive.", a: "ware", e: "" },
      { s: "____ did you put my keys?", a: "where", e: "" },
      { s: "You should ____ a coat today.", a: "wear", e: "" },
      { s: "The pottery ____ is handmade.", a: "ware", e: "" },
      { s: "____ is the nearest bathroom?", a: "where", e: "" },
      { s: "I always ____ my seatbelt.", a: "wear", e: "" },
      { s: "The table ____ looks antique.", a: "ware", e: "" }
    ]
  },
  {
    id: "its_its",
    title: "ITS / IT'S (2 words)",
    options: ["its","it's"],
    hint: "",
    items: [
      { s: "The cat licked ____ paw.", a: "its", e: "" },
      { s: "____ going to rain today.", a: "it's", e: "" },
      { s: "The tree lost ____ leaves.", a: "its", e: "" },
      { s: "____ time to go home.", a: "it's", e: "" },
      { s: "The dog wagged ____ tail.", a: "its", e: "" },
      { s: "____ a beautiful day outside.", a: "it's", e: "" },
      { s: "The bird built ____ nest.", a: "its", e: "" },
      { s: "____ important to study hard.", a: "it's", e: "" },
      { s: "The car lost ____ mirror.", a: "its", e: "" },
      { s: "____ been a long week.", a: "it's", e: "" }
    ]
  }
];

// Supabase configuration (same as snake game)
const SUPABASE_URL = 'https://bmnixnmqferqlcxublii.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_IidrOPKjc9tkqOwjJMhrrQ_z35awXmc'; // Public anon key (safe to expose in client code)
const LEADERBOARD_TABLE = 'homophone_leaderboard'; // Different table for homophone game

let useSupabase = false;

// Check if Supabase is configured
if (SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && 
    SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
  useSupabase = true;
  console.log("Using Supabase for server-side leaderboard");
} else {
  console.log("Supabase not configured - using localStorage (fallback)");
}

// DOM + game logic
const elSentence=document.getElementById("sentence");
const elAnswers=document.getElementById("answers");
const elTime=document.getElementById("timeLeft");
const elScore=document.getElementById("score");
const elAcc=document.getElementById("acc");
const startBtn=document.getElementById("startBtn");
const pauseBtn=document.getElementById("pauseBtn");
const resetBtn=document.getElementById("resetBtn");
const elToast=document.getElementById("toast");
const nameInput=document.getElementById("nameInput");
const saveBtn=document.getElementById("saveBtn");
const lbBody=document.getElementById("lbBody");

let currentPack=null,currentItem=null;
let timer=null,running=false,timeLeft=30;
let score=0,streak=0,correct=0,total=0;
let selectedWordCount=2; // Default to 2 words
let selectedDuration=30; // Default to 30 seconds
let nameSubmitted=false;

function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function shuffle(a){a=a.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function renderStats(){elTime.textContent=timeLeft;elScore.textContent=score;elAcc.textContent=total?Math.round(correct/total*100):100}
function nextQ(){
  currentItem=pick(currentPack.items);
  elSentence.textContent=currentItem.s;
  elAnswers.innerHTML="";
  elAnswers.className="answers"+(currentPack.options.length===3?" three":"");
  shuffle(currentPack.options).forEach(w=>{
    const b=document.createElement("button");
    b.className="ansBtn";
    b.textContent=w;
    b.onclick=()=>answer(w,b);
    elAnswers.appendChild(b);
  });
}
function answer(w,b){
  if(!running)return;
  total++;
  if(w===currentItem.a){correct++;streak++;score++;b.classList.add("good")}
  else{streak=0;timeLeft=Math.max(0,timeLeft-2);b.classList.add("bad")}
  renderStats();
  setTimeout(()=>{if(timeLeft<=0)end();else nextQ()},300);
}
function start(){
  if(running)return;
  running=true;
  if(!currentItem)nextQ();
  timer=setInterval(()=>{timeLeft--;renderStats();if(timeLeft<=0)end()},1000);
}
function end(){
  clearInterval(timer);
  timer=null;
  running=false;
  displayLeaderboard();
  nameSubmitted=false;
  saveBtn.disabled=!nameInput.value.trim();
}
function resetGame(){if(timer)clearInterval(timer);running=false;score=streak=correct=total=0;timeLeft=selectedDuration;renderStats();if(currentPack)nextQ()}

function setPackByWordCount(wordCount){
  selectedWordCount=wordCount;
  const availablePacks=PACKS.filter(p=>p.options.length===wordCount);
  if(availablePacks.length>0){
    currentPack=pick(availablePacks);
    resetGame();
  }
  // Update button states
  document.querySelectorAll('.packBtn').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.words==wordCount);
  });
}

function setDuration(duration){
  selectedDuration=duration;
  timeLeft=duration;
  renderStats();
  // Update button states
  document.querySelectorAll('.durationBtn').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.duration==duration);
  });
}

// Pack selection buttons
document.getElementById("packBtn2").onclick=()=>setPackByWordCount(2);
document.getElementById("packBtn3").onclick=()=>setPackByWordCount(3);

// Duration selection buttons
document.getElementById("durationBtn30").onclick=()=>setDuration(30);
document.getElementById("durationBtn60").onclick=()=>setDuration(60);
document.getElementById("durationBtn90").onclick=()=>setDuration(90);

startBtn.onclick=start;
resetBtn.onclick=resetGame;

// Initialize with default pack
setPackByWordCount(2);
setDuration(30); // Default to 30 seconds
renderStats();

// Supabase leaderboard functions
async function getHighScores() {
  if (useSupabase) {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=name,score,date,duration&order=score.desc&limit=10`, {
        method: 'GET',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        }
      });
      
      if (response.ok) {
        const scores = await response.json();
        console.log("ðŸ“Š Fetched scores from Supabase:", scores.length, "entries");
        return scores.map(s => ({
          name: s.name || "Anonymous",
          score: s.score || 0,
          date: s.date || new Date().toLocaleDateString(),
          duration: s.duration || null
        }));
      } else {
        const errorText = await response.text();
        console.error("âŒ Error fetching from Supabase:", response.status, errorText);
        // If table doesn't exist, fall back to localStorage
        if (response.status === 404) {
          console.log("âš ï¸ Supabase table not found, using localStorage");
        }
      }
    } catch (error) {
      console.error("âŒ Error fetching scores from Supabase:", error);
    }
  }
  
  // Fallback to localStorage
  try {
    const stored = localStorage.getItem('homophone_leaderboard');
    const scores = stored ? JSON.parse(stored) : [];
    if (scores.length > 0) {
      console.log("ðŸ“Š Fetched scores from localStorage:", scores.length, "entries");
    }
    return scores;
  } catch (e) {
    console.error("âŒ Error reading from localStorage:", e);
    return [];
  }
}

async function saveHighScores(scores) {
  let supabaseSuccess = false;
  
  if (useSupabase) {
    try {
      // Get current IDs
      const currentResponse = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=id`, {
        method: 'GET',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (currentResponse.ok) {
        const currentScores = await currentResponse.json();
        const currentIds = currentScores.map(s => s.id);
        
        // Delete existing scores
        if (currentIds.length > 0) {
          const deleteResponse = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?id=in.(${currentIds.join(',')})`, {
            method: 'DELETE',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            }
          });
        }
      }
      
      // Insert new scores
      if (scores.length > 0) {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(scores)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log("âœ… Leaderboard updated! Saved", result.length, "entries to Supabase");
          supabaseSuccess = true;
        } else {
          const errorText = await response.text();
          console.error("âŒ Error saving to Supabase:", response.status, errorText);
          // If table doesn't exist (404), fall back to localStorage
          if (response.status === 404) {
            console.log("âš ï¸ Supabase table not found, using localStorage");
          }
        }
      }
    } catch (error) {
      console.error("âŒ Error saving scores to Supabase:", error);
    }
  }
  
  // Always save to localStorage as backup (or primary if Supabase fails)
  try {
    localStorage.setItem('homophone_leaderboard', JSON.stringify(scores));
    if (supabaseSuccess) {
      console.log("ðŸ’¾ Scores also saved locally as backup");
    } else {
      console.log("ðŸ’¾ Scores saved locally (Supabase not configured or unavailable)");
    }
  } catch (e) {
    console.error("âŒ Error saving to localStorage:", e);
  }
}

async function addHighScore(name, score) {
  const scores = await getHighScores();
  const date = new Date().toLocaleDateString();
  const duration = selectedDuration; // Store the duration used for this game
  
  // Remove any existing entry with same name and score (avoid duplicates)
  const filtered = scores.filter(s => !(s.name === name && s.score === score));
  filtered.push({ name: name || "Anonymous", score: score, date: date, duration: duration });
  
  // Sort by score (highest first)
  filtered.sort((a, b) => b.score - a.score);
  // Keep only top 10
  const topScores = filtered.slice(0, 10);
  
  await saveHighScores(topScores);
  return topScores;
}

async function displayLeaderboard() {
  const scores = await getHighScores();
  if (scores.length === 0) {
    lbBody.innerHTML = '<tr><td colspan="4" class="tiny">No scores yet.</td></tr>';
    return;
  }
  
  lbBody.innerHTML = scores.map((s, i) => {
    const duration = s.duration ? ` (${s.duration}s)` : '';
    return `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.score}</td><td>${s.date}${duration}</td></tr>`;
  }).join('');
}

// Save button handler
saveBtn.onclick=async function(e){
  e.preventDefault();
  e.stopPropagation();
  if(nameSubmitted)return;
  const name=nameInput.value.trim()||"Anonymous";
  if(!name)return;
  const currentScore=score; // Capture current score
  nameSubmitted=true;
  saveBtn.disabled=true;
  try {
    await addHighScore(name,currentScore);
    await displayLeaderboard();
    elToast.textContent=`Score saved!`;
    elToast.className="toast good";
    elToast.style.display="block";
    setTimeout(()=>{elToast.style.display="none"},3000);
  } catch(error) {
    console.error("Error saving score:", error);
    elToast.textContent=`Error saving score. Please try again.`;
    elToast.className="toast bad";
    elToast.style.display="block";
    nameSubmitted=false;
    saveBtn.disabled=false;
  }
};

// Update save button state
nameInput.addEventListener("input",()=>{
  saveBtn.disabled=!nameInput.value.trim()||nameSubmitted;
});

// Load leaderboard on page load
displayLeaderboard();
</script>
</body>
</html>